<script>
  const SECRET_KEY = "300"; // Replace with your actual encryption key

  function decryptMessage(encrypted) {
    try {
      const bytes = CryptoJS.AES.decrypt(encrypted, SECRET_KEY);
      const originalText = bytes.toString(CryptoJS.enc.Utf8);
      return originalText || "[decryption error]";
    } catch (e) {
      return "[decryption error]";
    }
  }

  async function loadHistory() {
    const room = document.getElementById('roomInput').value.trim();
    if (!room) return;

    const res = await fetch(`/history/${room}`);
    if (!res.ok) {
      document.getElementById('output').innerHTML = `<p>Error loading history.</p>`;
      return;
    }

    const messages = await res.json();
    let html = '';
    for (const msg of messages) {
      const time = new Date(msg.timestamp).toLocaleString();

      // Check if encrypted message exists and is non-empty
      let displayedText = "";
      if (msg.encrypted) {
        displayedText = decryptMessage(msg.encrypted);
      } else if (msg.text) {
        displayedText = msg.text;
      } else {
        displayedText = "[no message text]";
      }

      const user = msg.user || "anon";
      html += `<p><strong>${user} [${time}]:</strong> ${displayedText}</p>`;
    }
    document.getElementById('output').innerHTML = html || '<p>No messages yet.</p>';
  }
</script>

