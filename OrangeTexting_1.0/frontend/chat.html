<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>OrangeTexting Chat</title>
  <style>
    body {
      background-color: #121212;
      color: #ffffff;
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      display: flex; flex-direction: column; height: 100vh;
    }
    #chat {
      flex-grow: 1;
      background-color: #1e1e1e;
      border: 1px solid #333;
      padding: 10px;
      overflow-y: auto;
      font-size: 1rem;
      word-wrap: break-word;
    }
    .message {
      margin-bottom: 12px;
      user-select: text; /* allow copy */
      white-space: pre-wrap;
    }
    .message img {
      max-width: 80%;
      height: auto;
      border-radius: 6px;
      margin-top: 5px;
      display: block;
    }
    #typing-status {
      color: #aaa;
      height: 20px;
      margin: 5px 10px;
    }
    #input-area {
      display: flex;
      padding: 10px;
      background-color: #222;
      border-top: 1px solid #333;
    }
    #input {
      flex-grow: 1;
      background-color: #333;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      padding: 8px;
      font-size: 1rem;
      resize: none;
      max-height: 100px;
      overflow-y: auto;
    }
    #send-btn, #upload-btn {
      margin-left: 10px;
      padding: 8px 12px;
      background-color: #444;
      color: #fff;
      border: 1px solid #555;
      border-radius: 4px;
      cursor: pointer;
    }
    #send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    @media (max-width: 600px) {
      body {
        font-size: 14px;
      }
      #input-area {
        flex-direction: column;
      }
      #input {
        margin-bottom: 8px;
        width: 100%;
      }
      #send-btn, #upload-btn {
        width: 100%;
        margin-left: 0;
      }
    }
  </style>
</head>
<body>
  <div id="chat" aria-live="polite" aria-atomic="false"></div>
  <div id="typing-status" aria-live="polite" aria-atomic="true"></div>
  <div id="input-area">
    <textarea id="input" rows="2" placeholder="Type your message here (Enter to send, Shift+Enter new line)"></textarea>
    <input type="file" id="upload-btn" accept="image/*" title="Upload Image" aria-label="Upload image" />
    <button id="send-btn" disabled>Send</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/crypto-js.js"></script>
  <script>
    (() => {
      const socket = io();
      const urlParams = new URLSearchParams(window.location.search);
      const room = urlParams.get('room');
      if (!room) {
        alert("Room ID not specified in URL (use ?room=roomname)");
        throw new Error("No room ID specified");
      }

      const username = prompt("Enter your username:") || "Anonymous";
      const secret = prompt("Enter shared secret:") || "";

      const chat = document.getElementById('chat');
      const typingStatus = document.getElementById('typing-status');
      const input = document.getElementById('input');
      const sendBtn = document.getElementById('send-btn');
      const uploadBtn = document.getElementById('upload-btn');

      let typingTimeout;

      function scrollToBottom() {
        chat.scrollTop = chat.scrollHeight;
      }

      function addMessage(data) {
        const { user, text, timestamp, imageData } = data;
        const timeStr = new Date(timestamp || Date.now()).toLocaleTimeString();

        const msgDiv = document.createElement('div');
        msgDiv.classList.add('message');

        const header = document.createElement('strong');
        header.textContent = `${user} [${timeStr}]:`;
        msgDiv.appendChild(header);

        if (text) {
          const textNode = document.createElement('span');
          textNode.textContent = " " + text;
          msgDiv.appendChild(textNode);
        }

        if (imageData) {
          const img = document.createElement('img');
          img.src = imageData;
          img.alt = "User uploaded image";
          msgDiv.appendChild(img);
        }

        chat.appendChild(msgDiv);
        scrollToBottom();
      }

      function encryptMessage(msg) {
        return CryptoJS.AES.encrypt(msg, secret).toString();
      }

      function decryptMessage(encrypted) {
        try {
          const bytes = CryptoJS.AES.decrypt(encrypted, secret);
          const decrypted = bytes.toString(CryptoJS.enc.Utf8);
          return decrypted;
        } catch {
          return null;
        }
      }

      socket.emit('join-room', { roomId: room });

      socket.on('receive-message', (data) => {
        // data is object with either encrypted or raw fields
        // In this setup, server sends the raw object, so encrypt on client side for consistency.
        // We'll just show data directly
        addMessage(data);
      });

      socket.on('typing', (data) => {
        typingStatus.textContent = `${data.user} is typing...`;
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          typingStatus.textContent = '';
        }, 2000);
      });

      input.addEventListener('input', () => {
        sendBtn.disabled = !input.value.trim() && !uploadBtn.files.length;
        socket.emit('typing', { roomId: room, user: username });
      });

      // Handle shift+enter newline and enter send message
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          if (!sendBtn.disabled) sendBtn.click();
        }
      });

      sendBtn.addEventListener('click', () => {
        const text = input.value.trim();
        if (!text && !uploadBtn.files.length) return;

        if (uploadBtn.files.length) {
          const file = uploadBtn.files[0];
          const reader = new FileReader();
          reader.onload = function(e) {
            const base64 = e.target.result;
            const message = JSON.stringify({ user: username, timestamp: Date.now(), text, imageData: base64 });
            const encrypted = encryptMessage(message);
            socket.emit('send-message', JSON.parse(message)); // send raw object, server stores raw
            input.value = '';
            uploadBtn.value = '';
            sendBtn.disabled = true;
          };
          reader.readAsDataURL(file);
        } else {
          const message = JSON.stringify({ user: username, timestamp: Date.now(), text });
          const encrypted = encryptMessage(message);
          socket.emit('send-message', JSON.parse(message));
          input.value = '';
          sendBtn.disabled = true;
        }
      });
    })();
  </script>
</body>
</html>
